<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUSIVE - Checkout</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/DDhLPnfC/1426529068614029372-1.png">
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Backend API Configuration -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.05);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) perspective(1000px) rotateX(10deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) perspective(1000px) rotateX(0deg);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 133, 255, 0.3), 0 0 40px rgba(0, 133, 255, 0.2);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 133, 255, 0.5), 0 0 60px rgba(0, 133, 255, 0.3);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes rotate3d {
            0% {
                transform: perspective(1000px) rotateY(0deg) rotateX(0deg);
            }
            25% {
                transform: perspective(1000px) rotateY(2deg) rotateX(1deg);
            }
            50% {
                transform: perspective(1000px) rotateY(0deg) rotateX(0deg);
            }
            75% {
                transform: perspective(1000px) rotateY(-2deg) rotateX(-1deg);
            }
            100% {
                transform: perspective(1000px) rotateY(0deg) rotateX(0deg);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0a0e1f 0%, #070a15 50%, #050810 100%);
            min-height: 100vh;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
            color: #ffffff;
        }

        /* Geometric Pattern Background (Hexagonal/Diamond Grid) */
        .geometric-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.2;
            background-image: 
                repeating-linear-gradient(60deg, transparent, transparent 40px, rgba(59, 130, 246, 0.08) 40px, rgba(59, 130, 246, 0.08) 41px, transparent 41px, transparent 80px),
                repeating-linear-gradient(120deg, transparent, transparent 40px, rgba(59, 130, 246, 0.08) 40px, rgba(59, 130, 246, 0.08) 41px, transparent 41px, transparent 80px),
                repeating-linear-gradient(0deg, transparent, transparent 69px, rgba(59, 130, 246, 0.08) 69px, rgba(59, 130, 246, 0.08) 70px, transparent 70px, transparent 138px);
            background-size: 138px 120px, 138px 120px, 138px 120px;
            background-position: 0 0, 69px 60px, 0 0;
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }
        
        /* Glowing Dots Pattern */
        .glowing-dots {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                radial-gradient(circle at 12% 18%, rgba(59, 130, 246, 0.5) 2px, transparent 2px),
                radial-gradient(circle at 28% 42%, rgba(59, 130, 246, 0.4) 1.5px, transparent 1.5px),
                radial-gradient(circle at 48% 28%, rgba(59, 130, 246, 0.45) 2px, transparent 2px),
                radial-gradient(circle at 68% 55%, rgba(59, 130, 246, 0.5) 1.5px, transparent 1.5px),
                radial-gradient(circle at 82% 22%, rgba(59, 130, 246, 0.4) 2px, transparent 2px),
                radial-gradient(circle at 22% 68%, rgba(59, 130, 246, 0.45) 1.5px, transparent 1.5px),
                radial-gradient(circle at 42% 82%, rgba(59, 130, 246, 0.5) 2px, transparent 2px),
                radial-gradient(circle at 58% 8%, rgba(59, 130, 246, 0.4) 1.5px, transparent 1.5px),
                radial-gradient(circle at 88% 75%, rgba(59, 130, 246, 0.45) 2px, transparent 2px),
                radial-gradient(circle at 8% 48%, rgba(59, 130, 246, 0.5) 1.5px, transparent 1.5px),
                radial-gradient(circle at 35% 15%, rgba(59, 130, 246, 0.4) 2px, transparent 2px),
                radial-gradient(circle at 72% 38%, rgba(59, 130, 246, 0.45) 1.5px, transparent 1.5px),
                radial-gradient(circle at 15% 88%, rgba(59, 130, 246, 0.5) 2px, transparent 2px),
                radial-gradient(circle at 92% 12%, rgba(59, 130, 246, 0.4) 1.5px, transparent 1.5px),
                radial-gradient(circle at 55% 65%, rgba(59, 130, 246, 0.45) 2px, transparent 2px);
            background-size: 300px 300px, 280px 280px, 320px 320px, 290px 290px, 310px 310px, 300px 300px, 280px 280px, 320px 320px, 290px 290px, 310px 310px, 300px 300px, 280px 280px, 320px 320px, 290px 290px, 310px 310px;
            background-position: 0 0, 80px 120px, 200px 60px, 400px 180px, 550px 90px, 120px 280px, 380px 420px, 520px 40px, 650px 380px, 60px 220px, 180px 50px, 480px 150px, 100px 450px, 680px 80px, 320px 300px;
            animation: pulse 4s ease-in-out infinite;
        }

        .page-header {
            text-align: center;
            margin-bottom: 48px;
            position: relative;
            z-index: 10;
            animation: slideInUp 0.8s ease-out;
        }

        .page-header h1 {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #0085ff 50%, #00a8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            text-shadow: 0 0 40px rgba(0, 133, 255, 0.5);
            animation: glow 3s ease-in-out infinite;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: start;
            position: relative;
            z-index: 10;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .section {
            background: linear-gradient(145deg, rgba(15, 20, 40, 0.95) 0%, rgba(10, 15, 30, 0.95) 50%, rgba(8, 12, 25, 0.95) 100%);
            padding: 40px;
            border-radius: 1.5rem;
            border: 2px solid rgba(0, 133, 255, 0.3);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 40px rgba(0, 133, 255, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            transform: perspective(1000px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInUp 0.8s ease-out backwards;
        }

        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section:nth-child(4) { animation-delay: 0.4s; }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 133, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .section:hover {
            transform: perspective(1000px) translateY(-5px) rotateX(2deg);
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 60px rgba(0, 133, 255, 0.4);
            border-color: rgba(0, 133, 255, 0.5);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 28px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 133, 255, 0.3);
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #0085ff, #00a8ff);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(0, 133, 255, 0.5);
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #9ca3af;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .form-group:focus-within label {
            color: #0085ff;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0.75rem;
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(0, 133, 255, 0.8);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            box-shadow: 
                0 0 0 4px rgba(0, 133, 255, 0.2),
                0 8px 25px rgba(0, 133, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card-fields {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .input-wrapper {
            position: relative;
        }

        .card-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .form-group:focus-within .card-icon {
            transform: translateY(-50%) scale(1.1);
        }

        .card-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* Stripe Elements Styling */
        .stripe-element {
            padding: 14px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .stripe-element:focus-within {
            border-color: rgba(0, 133, 255, 0.8);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            box-shadow: 
                0 0 0 4px rgba(0, 133, 255, 0.2),
                0 8px 25px rgba(0, 133, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .StripeElement {
            color: #ffffff;
            font-size: 15px;
            font-family: inherit;
        }

        .StripeElement--invalid {
            border-color: #ef4444;
        }

        .StripeElement--focus {
            border-color: rgba(0, 133, 255, 0.8);
        }

        #card-errors {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            display: none;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        #card-errors.show {
            display: block;
        }

        .right-section {
            position: sticky;
            top: 40px;
        }

        .order-summary {
            background: linear-gradient(145deg, rgba(15, 20, 40, 0.95) 0%, rgba(10, 15, 30, 0.95) 50%, rgba(8, 12, 25, 0.95) 100%);
            padding: 40px;
            border: 2px solid rgba(0, 133, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 40px rgba(0, 133, 255, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            transform: perspective(1000px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInUp 0.8s ease-out 0.5s backwards;
        }

        .order-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 133, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .order-summary:hover {
            transform: perspective(1000px) translateY(-5px) rotateX(2deg);
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 60px rgba(0, 133, 255, 0.4);
            border-color: rgba(0, 133, 255, 0.5);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-details {
            display: flex;
            gap: 16px;
            flex: 1;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 133, 255, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info h3 {
            font-size: 15px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 6px;
            text-shadow: 0 2px 10px rgba(0, 133, 255, 0.3);
        }

        .item-info p {
            font-size: 13px;
            color: #9ca3af;
        }

        .item-price {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(0, 133, 255, 0.4);
        }

        .qty-section {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .qty-label {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .qty-input {
            width: 60px;
            padding: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0.5rem;
            text-align: center;
            font-size: 14px;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .qty-input:focus {
            outline: none;
            border-color: rgba(0, 133, 255, 0.8);
            box-shadow: 0 0 0 3px rgba(0, 133, 255, 0.2), 0 4px 15px rgba(0, 133, 255, 0.3);
        }

        .remove-link {
            font-size: 12px;
            color: #9ca3af;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-link:hover {
            color: #ef4444;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .discount-section {
            margin-bottom: 28px;
            display: flex;
            gap: 12px;
        }

        .discount-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0.75rem;
            font-size: 14px;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .discount-input:focus {
            outline: none;
            border-color: rgba(0, 133, 255, 0.8);
            box-shadow: 0 0 0 3px rgba(0, 133, 255, 0.2), 0 4px 15px rgba(0, 133, 255, 0.3);
        }

        .discount-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .apply-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #0085ff 0%, #00a8ff 50%, #0066cc 100%);
            border: none;
            border-radius: 0.75rem;
            font-size: 13px;
            font-weight: 700;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 6px 20px rgba(0, 133, 255, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .apply-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .apply-btn:hover::before {
            left: 100%;
        }

        .apply-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 133, 255, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .apply-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .summary-lines {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-line {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #9ca3af;
            transition: color 0.3s;
        }

        .summary-line:hover {
            color: #ffffff;
        }

        .summary-line.total {
            font-size: 20px;
            font-weight: 800;
            color: #ffffff;
            border: none;
            padding-top: 12px;
            text-shadow: 0 2px 15px rgba(0, 133, 255, 0.4);
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 24px;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .security-badge svg {
            width: 18px;
            height: 18px;
            filter: drop-shadow(0 0 8px rgba(0, 133, 255, 0.5));
            animation: float 3s ease-in-out infinite;
        }

        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #0085ff 0%, #00a8ff 50%, #0066cc 100%);
            color: white;
            border: none;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 28px;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 133, 255, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-submit:hover::before {
            left: 100%;
        }

        .btn-submit:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 133, 255, 0.6), 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-submit:active {
            transform: translateY(-1px) scale(0.98);
        }

        .error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2), 0 4px 15px rgba(239, 68, 68, 0.3) !important;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            display: none;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            animation: slideInUp 0.3s ease-out;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            display: none;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            font-weight: 700;
            font-size: 14px;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: slideInUp 0.5s ease-out;
        }

        .success-message.show {
            display: block;
        }

        .success-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a0e1f 0%, #070a15 50%, #050810 100%);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
            animation: slideInUp 0.8s ease-out;
        }

        .success-page.show {
            display: flex;
        }

        .success-ticket {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%);
            border: 3px solid rgba(16, 185, 129, 0.5);
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 60px rgba(16, 185, 129, 0.4);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .success-ticket::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.5);
            animation: float 3s ease-in-out infinite;
        }

        .success-icon svg {
            width: 60px;
            height: 60px;
            color: white;
        }

        .success-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 2px 20px rgba(16, 185, 129, 0.5);
        }

        .success-message-text {
            font-size: 1.125rem;
            color: #9ca3af;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .discord-button {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
            color: white;
            text-decoration: none;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
            margin-bottom: 1.5rem;
        }

        .discord-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(88, 101, 242, 0.6);
        }

        .discord-button svg {
            width: 24px;
            height: 24px;
        }

        .discord-button:visited {
            color: white;
        }

        .failure-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a0e1f 0%, #070a15 50%, #050810 100%);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
            animation: slideInUp 0.8s ease-out;
        }

        .failure-page.show {
            display: flex;
        }

        .failure-ticket {
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.15) 100%);
            border: 3px solid rgba(239, 68, 68, 0.5);
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 60px rgba(239, 68, 68, 0.4);
            backdrop-filter: blur(10px);
        }

        .failure-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.5);
        }

        .failure-icon svg {
            width: 60px;
            height: 60px;
            color: white;
        }

        .failure-title {
            font-size: 2rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 2px 20px rgba(239, 68, 68, 0.5);
        }

        .retry-button {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #0085ff 0%, #0066cc 100%);
            color: white;
            text-decoration: none;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(0, 133, 255, 0.4);
            margin-top: 1.5rem;
            border: none;
            cursor: pointer;
        }

        .retry-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(0, 133, 255, 0.6);
        }

        .product-selector {
            margin-bottom: 24px;
        }

        .product-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .product-option {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .product-option:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 133, 255, 0.5);
            box-shadow: 0 8px 25px rgba(0, 133, 255, 0.3);
        }

        .product-option.selected {
            border-color: rgba(0, 133, 255, 0.8);
            background: linear-gradient(135deg, rgba(0, 133, 255, 0.2) 0%, rgba(0, 102, 204, 0.15) 100%);
            box-shadow: 0 8px 25px rgba(0, 133, 255, 0.4);
        }

        .product-option h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .product-option .price {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0085ff;
            text-shadow: 0 2px 10px rgba(0, 133, 255, 0.4);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 133, 255, 0.3);
            border-top-color: #0085ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ffffff;
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .right-section {
                position: static;
            }
        }

        @media (max-width: 640px) {
            .page-header h1 {
                font-size: 32px;
            }

            .section {
                padding: 28px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .main-container {
                gap: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Geometric Pattern Background -->
    <div class="geometric-pattern"></div>
    
    <!-- Glowing Dots Pattern -->
    <div class="glowing-dots"></div>

    <div class="page-header">
        <h1>LUSIVE</h1>
    </div>

    <div class="main-container">
        <div class="left-section">
            <form id="paymentForm">
                <div class="section">
                    <h2 class="section-title">Your Email</h2>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input
                            type="email"
                            id="email"
                            placeholder="Email address"
                            required
                        >
                        <span class="error-message" id="emailError">Please enter a valid email</span>
                    </div>
                    <p style="font-size: 13px; color: #9ca3af; margin-top: 12px;">You'll receive receipts and notifications at this email</p>
                </div>

                <div class="section">
                    <h2 class="section-title">Delivery</h2>
                    <div class="form-group">
                        <label for="cardName">Full Name</label>
                        <input
                            type="text"
                            id="cardName"
                            placeholder="John Doe"
                            required
                        >
                        <span class="error-message" id="nameError">Please enter a valid name</span>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input
                            type="text"
                            id="address"
                            placeholder="123 Main Street"
                            required
                        >
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" placeholder="New York" required>
                        </div>
                        <div class="form-group">
                            <label for="zip">Zip Code</label>
                            <input type="text" id="zip" placeholder="10001" required>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Payment & Discounts</h2>
                    <div class="card-fields">
                        <div class="form-group">
                            <label for="card-element">Card Number</label>
                            <div id="card-element" class="stripe-element">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            <div id="card-errors" class="error-message" role="alert"></div>
                        </div>
                    </div>

                    <div class="discount-section" style="margin-top: 24px;">
                        <input type="text" class="discount-input" placeholder="Gift or Discount Code">
                        <button type="button" class="apply-btn">Apply</button>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Review & Purchase</h2>
                    <button type="submit" class="btn-submit">Complete Purchase</button>
                    <div class="security-badge">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                        </svg>
                        <span>SECURE SSL CHECKOUT</span>
                    </div>
                    <div class="error-message" id="paymentError" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 1rem; border-radius: 0.75rem; margin-top: 1rem;">
                        Payment declined. Please try again.
                    </div>
                </div>
            </form>
        </div>

        <div class="right-section">
            <div class="order-summary">
                <h2 class="section-title">Order Summary</h2>

                <div class="order-item" id="orderItem">
                    <div class="item-details">
                        <div class="item-image" id="itemImage">
                            <img src="https://i.ibb.co/DDhLPnfC/1426529068614029372-1.png" alt="Product Image" id="productImage">
                        </div>
                        <div class="item-info">
                            <h3 id="itemName">Select a Plan</h3>
                            <p>Quantity: 1 item</p>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="item-price" id="itemPrice">¬£0.00</div>
                    </div>
                </div>


                <div class="summary-lines">
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span id="subtotal">¬£0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Tax</span>
                        <span>¬£0.00</span>
                    </div>
                    <div class="summary-line total">
                        <span>Total</span>
                        <span id="total">¬£0.00</span>
                    </div>
                </div>

                <div class="security-badge" style="justify-content: center;">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                    </svg>
                    <span>SECURE SSL CHECKOUT</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Processing Payment...</div>
    </div>

    <!-- Success Page -->
    <div class="success-page" id="successPage">
        <div class="success-ticket">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h1 class="success-title">üéâ Payment Successful!</h1>
            <p class="success-message-text">
                Your payment has been processed successfully!<br>
                Join our Discord server to get access to your purchase.
            </p>
            <a href="https://discord.gg/lusiveofficial" target="_blank" class="discord-button" id="discordButton">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.1.1 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.1 16.1 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02M8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12m6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12"/>
                </svg>
                <span>Join Discord to Get Access</span>
            </a>
            <p style="color: #9ca3af; font-size: 0.875rem; margin-top: 1rem;">
                Make sure to create a ticket above all messages with your payment proof!
            </p>
        </div>
    </div>

    <!-- Failure Page -->
    <div class="failure-page" id="failurePage">
        <div class="failure-ticket">
            <div class="failure-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </div>
            <h1 class="failure-title">Payment Declined</h1>
            <p class="success-message-text" style="color: #ef4444;">
                Your payment could not be processed.<br>
                Please check your card details and try again.
            </p>
            <button class="retry-button" onclick="document.getElementById('failurePage').classList.remove('show');">
                Try Again
            </button>
        </div>
    </div>

    <script>
        const cardNameInput = document.getElementById('cardName');
        const emailInput = document.getElementById('email');
        const form = document.getElementById('paymentForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successPage = document.getElementById('successPage');
        const failurePage = document.getElementById('failurePage');
        const paymentError = document.getElementById('paymentError');
        
        // Stripe Elements
        let cardElement = null;
        let elements = null;

        // Stripe initialization
        let stripe = null;
        // Use your Stripe publishable key here
        // For testing, you can use test keys: pk_test_...
        // For production, use live keys: pk_live_...
        const stripePublishableKey = 'pk_live_51RkhnPC5ZigTpayqde2S4jM4VLdAYYo003Q1e7lHxALlG4dZjmZTSZQnz8UCCjVltelzJvYtB3fMuZQoQfIrE8Tc00Xy5Lk6QV';

        // Initialize Stripe with error handling
        function initStripe() {
            if (typeof Stripe === 'undefined') {
                console.error('Stripe.js library not loaded');
                return false;
            }
            
            try {
                stripe = Stripe(stripePublishableKey);
                console.log('Stripe initialized successfully');
                
                // Initialize Stripe Elements
                if (stripe) {
                    elements = stripe.elements();
                    
                    // Create card element
                    const cardElementOptions = {
                        style: {
                            base: {
                                color: '#ffffff',
                                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                                fontSmoothing: 'antialiased',
                                fontSize: '15px',
                                '::placeholder': {
                                    color: 'rgba(255, 255, 255, 0.4)',
                                },
                            },
                            invalid: {
                                color: '#ef4444',
                                iconColor: '#ef4444',
                            },
                        },
                        hidePostalCode: true,
                    };
                    
                    cardElement = elements.create('card', cardElementOptions);
                    cardElement.mount('#card-element');
                    
                    // Handle real-time validation errors from the card Element
                    cardElement.on('change', function(event) {
                        const displayError = document.getElementById('card-errors');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                            displayError.classList.add('show');
                        } else {
                            displayError.textContent = '';
                            displayError.classList.remove('show');
                        }
                    });
                    
                    console.log('Stripe Elements initialized successfully');
                }
                
                return true;
            } catch (error) {
                console.error('Error initializing Stripe:', error);
                alert('Error initializing payment system. Please check the Stripe API key.');
                return false;
            }
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            // Test backend connection on page load
            async function testBackendConnection() {
                const backendUrl = window.BACKEND_API_URL || 'https://lusivebackend.onrender.com';
                try {
                    const healthCheck = await fetch(`${backendUrl}/api/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (healthCheck.ok) {
                        console.log('‚úÖ Backend connection successful:', backendUrl);
                    } else {
                        console.warn('‚ö†Ô∏è Backend health check failed:', healthCheck.status);
                    }
                } catch (error) {
                    console.error('‚ùå Backend connection failed:', error.message);
                    console.error('Backend URL:', backendUrl);
                }
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                initStripe();
                testBackendConnection();
            });
        } else {
            initStripe();
            // Test backend connection if page already loaded
            (async () => {
                const backendUrl = window.BACKEND_API_URL || 'https://lusivebackend.onrender.com';
                try {
                    const healthCheck = await fetch(`${backendUrl}/api/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (healthCheck.ok) {
                        console.log('‚úÖ Backend connection successful:', backendUrl);
                    } else {
                        console.warn('‚ö†Ô∏è Backend health check failed:', healthCheck.status);
                    }
                } catch (error) {
                    console.error('‚ùå Backend connection failed:', error.message);
                    console.error('Backend URL:', backendUrl);
                }
            })();
        }

        // Product selection from URL parameters
        let selectedProduct = null;
        let appliedDiscount = null; // Discount code state

        // Product price mapping (in pounds)
        const productPrices = {
            'Week': { price: 10, amount: 1000 }, // ¬£10 = 1000 pence
            'Month': { price: 15, amount: 1500 }, // ¬£15 = 1500 pence
            'Lifetime': { price: 25, amount: 2500 } // ¬£25 = 2500 pence
        };

        function updateOrderSummary() {
            if (selectedProduct) {
                document.getElementById('itemName').textContent = selectedProduct.plan + ' Plan';
                
                // Always use the exact plan price - no discounts applied to payment
                const planPrice = selectedProduct.price;
                
                document.getElementById('itemPrice').textContent = '¬£' + planPrice.toFixed(2);
                document.getElementById('subtotal').textContent = '¬£' + planPrice.toFixed(2);
                
                // Update total display - always show plan price
                document.getElementById('total').textContent = '¬£' + planPrice.toFixed(2);
                
                // Update selectedProduct amount for payment processing - use exact plan amount
                // Get the original amount from productPrices mapping
                if (productPrices[selectedProduct.plan]) {
                    selectedProduct.amount = productPrices[selectedProduct.plan].amount;
                } else {
                    // Fallback: calculate from price
                    selectedProduct.amount = Math.round(planPrice * 100);
                }
                
                // Product image is already set, no need to update
            }
        }

        // Get product from URL params and set it immediately
        const urlParams = new URLSearchParams(window.location.search);
        const planParam = urlParams.get('plan');
        const priceParam = urlParams.get('price');
        
        if (planParam && productPrices[planParam]) {
            const productInfo = productPrices[planParam];
            selectedProduct = {
                plan: planParam,
                price: productInfo.price,
                amount: productInfo.amount
            };
            updateOrderSummary();
        } else if (planParam && priceParam) {
            // Fallback: use price from URL if plan not in mapping
            const price = parseFloat(priceParam);
            selectedProduct = {
                plan: planParam,
                price: price,
                amount: Math.round(price * 100) // Convert pounds to pence
            };
            updateOrderSummary();
        } else {
            // No product selected - redirect back to homepage
            alert('No product selected. Redirecting to homepage...');
            window.location.href = 'index.html';
        }

        // Add 3D tilt effect to sections
        document.querySelectorAll('.section, .order-summary').forEach(section => {
            section.addEventListener('mousemove', function(e) {
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const rotateX = (y - centerY) / 20;
                const rotateY = (centerX - x) / 20;
                
                this.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-5px)`;
            });
            
            section.addEventListener('mouseleave', function() {
                this.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateY(0)';
            });
        });

        // Stripe Elements handles card input automatically - no manual input handlers needed

        cardNameInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, '');
        });

        // Discount code functionality
        const discountInputs = document.querySelectorAll('.discount-input');
        const applyButtons = document.querySelectorAll('.apply-btn');

        applyButtons.forEach((button, index) => {
            button.addEventListener('click', async function() {
                const discountCode = discountInputs[index].value.trim();
                
                if (!discountCode) {
                    alert('Please enter a discount code');
                    return;
                }

                // Disable button while validating
                button.disabled = true;
                button.textContent = 'Validating...';

                try {
                    // Determine API base URL
                    const BACKEND_URL = window.BACKEND_API_URL || 'https://lusivebackend.onrender.com'; // Fallback to your backend URL
                    const isLocal = window.location.hostname === 'localhost' || 
                                   window.location.hostname === '127.0.0.1' || 
                                   window.location.protocol === 'file:';
                    const apiBaseUrl = BACKEND_URL || (isLocal ? 'http://localhost:3000' : 'https://lusivebackend.onrender.com');
                    
                    console.log('Discount API Base URL:', apiBaseUrl);

                    // Validate discount code with Stripe
                    const response = await fetch(`${apiBaseUrl}/api/validate-discount`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: discountCode,
                            plan: selectedProduct ? selectedProduct.plan : null,
                            amount: selectedProduct ? selectedProduct.amount : 0
                        })
                    });

                    const data = await response.json();

                    if (data.valid) {
                        // Calculate discount
                        let discountPercentage = 0;
                        let discountAmount = 0;

                        if (data.discountType === 'percentage') {
                            discountPercentage = data.discount / 100;
                            discountAmount = Math.round(selectedProduct.amount * discountPercentage);
                        } else {
                            // Fixed amount discount
                            discountAmount = data.discount; // Already in pence
                            discountPercentage = discountAmount / selectedProduct.amount;
                        }

                        appliedDiscount = {
                            code: discountCode,
                            percentage: discountPercentage,
                            amount: discountAmount,
                            promotionCodeId: data.promotionCodeId,
                            couponId: data.couponId,
                            discountType: data.discountType
                        };
                        
                        // Update all discount inputs to show applied state
                        discountInputs.forEach(input => {
                            input.value = discountCode;
                            input.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                            input.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                        });
                        
                        // Update button text
                        applyButtons.forEach(btn => {
                            btn.textContent = 'Applied ‚úì';
                            btn.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
                            btn.disabled = false;
                        });
                        
                        // Recalculate totals
                        updateOrderSummary();
                        
                        const discountText = data.discountType === 'percentage' 
                            ? `${data.discount}% off` 
                            : `¬£${(data.discount / 100).toFixed(2)} off`;
                        alert(`Discount code "${discountCode}" applied successfully! ${discountText}`);
                    } else {
                        alert(data.error || 'Invalid discount code. Please try again.');
                        discountInputs.forEach(input => {
                            input.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                        });
                        button.disabled = false;
                        button.textContent = 'Apply';
                    }
                } catch (error) {
                    console.error('Error validating discount:', error);
                    alert('Failed to validate discount code. Please check your connection and try again.');
                    button.disabled = false;
                    button.textContent = 'Apply';
                }
            });
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            let isValid = true;

            const emailValue = emailInput.value.trim();
            if (!emailValue.includes('@')) {
                showError('email', 'emailError');
                isValid = false;
            } else {
                hideError('email', 'emailError');
            }

            const nameValue = cardNameInput.value.trim();
            if (nameValue.length < 3) {
                showError('cardName', 'nameError');
                isValid = false;
            } else {
                hideError('cardName', 'nameError');
            }

            // Validate address fields
            const addressValue = document.getElementById('address').value.trim();
            if (addressValue.length < 5) {
                isValid = false;
            }

            const cityValue = document.getElementById('city').value.trim();
            if (cityValue.length < 2) {
                isValid = false;
            }

            const zipValue = document.getElementById('zip').value.trim();
            if (zipValue.length < 3) {
                isValid = false;
            }

            // Card validation is handled by Stripe Elements
            // Check if card element has any errors
            const cardErrors = document.getElementById('card-errors');
            if (cardErrors && cardErrors.classList.contains('show') && cardErrors.textContent.trim() !== '') {
                isValid = false;
            }

            // Check if Stripe card element is properly initialized
            if (!cardElement) {
                alert('Payment system is not ready. Please wait a moment and try again.');
                isValid = false;
            }

            if (isValid) {
                if (!selectedProduct) {
                    alert('No product selected. Please select a product from the homepage.');
                    window.location.href = 'index.html';
                    return;
                }

                // Process payment with Stripe
                processPayment();
            } else {
                // Show error message if validation failed
                if (!emailInput.value.trim() || !cardNameInput.value.trim()) {
                    alert('Please fill in all required fields.');
                }
            }
        });

        async function processPayment() {
            loadingOverlay.classList.add('show');
            paymentError.style.display = 'none';

            try {
                if (!stripe) {
                    if (typeof Stripe === 'undefined') {
                        throw new Error('Stripe.js library not loaded. Please refresh the page.');
                    }
                    
                    try {
                        stripe = Stripe(stripePublishableKey);
                    } catch (stripeError) {
                        throw new Error('Invalid Stripe API key. Please check your publishable key in form.html');
                    }
                }

                // Determine API base URL
                // For production, set this to your backend URL: 'https://your-backend-url.com'
                // For local development, it will use localhost:3000
                const BACKEND_URL = window.BACKEND_API_URL || 'https://lusivebackend.onrender.com'; // Fallback to your backend URL
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.protocol === 'file:';
                const apiBaseUrl = BACKEND_URL || (isLocal ? 'http://localhost:3000' : 'https://lusivebackend.onrender.com');
                
                console.log('API Base URL:', apiBaseUrl);
                console.log('Backend API URL from config:', window.BACKEND_API_URL);

                // Ensure we have all required values
                const email = emailInput.value.trim();
                
                if (!selectedProduct) {
                    throw new Error('No product selected. Please select a product from the homepage.');
                }
                
                const plan = selectedProduct.plan;
                
                // Always use the exact plan amount from productPrices mapping
                let amount = null;
                if (productPrices[plan]) {
                    amount = productPrices[plan].amount; // Use exact amount from mapping
                } else if (selectedProduct.amount) {
                    amount = Number(selectedProduct.amount);
                } else if (selectedProduct.price) {
                    amount = Math.round(selectedProduct.price * 100);
                } else {
                    throw new Error('Product amount is missing. Please select a product again.');
                }
                
                // Validate amount is a valid positive number
                amount = parseInt(amount, 10);
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Invalid product amount. Please select a product again.');
                }
                
                // Ensure amount meets Stripe minimum requirement (30 pence for GBP)
                const minAmount = 30;
                if (amount < minAmount) {
                    amount = minAmount;
                }
                
                if (!email) {
                    throw new Error('Email is required. Please enter your email address.');
                }
                
                if (!plan) {
                    throw new Error('Product plan is missing. Please select a product from the homepage.');
                }

                // Create payment intent with validated values
                // Always use exact plan amount - no discount codes applied
                const requestBody = {
                    amount: Number(amount),
                    currency: 'gbp',
                    email: String(email),
                    plan: String(plan),
                    discountCode: null // Disable discount codes - user pays exact plan price
                };
                
                // Create payment intent
                console.log('Sending request to:', `${apiBaseUrl}/api/create-payment-intent`);
                console.log('Request body:', requestBody);
                
                const response = await fetch(`${apiBaseUrl}/api/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).catch(error => {
                    console.error('Fetch error:', error);
                    throw new Error(`Network error: ${error.message}. Please check your backend URL: ${apiBaseUrl || 'Not set'}`);
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', response.status, errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText || 'Failed to create payment intent' };
                    }
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const { clientSecret, error } = await response.json();

                if (error) {
                    throw new Error(error);
                }

                if (!clientSecret) {
                    throw new Error('No client secret received from server');
                }

                // Prepare payment method options
                const paymentMethodOptions = {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: cardNameInput.value.trim(),
                            email: emailInput.value.trim(),
                            address: {
                                line1: document.getElementById('address').value.trim(),
                                city: document.getElementById('city').value.trim(),
                                postal_code: document.getElementById('zip').value.trim(),
                                country: 'GB'
                            }
                        }
                    }
                };

                // Confirm payment using Stripe Elements
                // Note: Discount is already applied when creating the payment intent on the server
                const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, paymentMethodOptions);

                loadingOverlay.classList.remove('show');

                if (confirmError) {
                    showPaymentFailure(confirmError.message);
                    return;
                }

                if (paymentIntent.status === 'succeeded') {
                    // Send success notification to backend
                    try {
                        await fetch(`${apiBaseUrl}/api/payment-success`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paymentIntentId: paymentIntent.id,
                                email: emailInput.value.trim(),
                                plan: selectedProduct.plan,
                                amount: selectedProduct.amount
                            })
                        });
                    } catch (err) {
                        console.error('Failed to send success notification:', err);
                    }

                    // Show success page
                    showPaymentSuccess();
                } else {
                    showPaymentFailure('Payment was not completed');
                }

            } catch (error) {
                loadingOverlay.classList.remove('show');
                showPaymentFailure(error.message || 'An error occurred. Please try again.');
            }
        }

        function showPaymentSuccess() {
            successPage.classList.add('show');
            
            // Create Discord ticket link with payment info
            const discordButton = document.getElementById('discordButton');
            const paymentInfo = encodeURIComponent(`Payment Successful!\nPlan: ${selectedProduct.plan}\nAmount: ¬£${selectedProduct.price.toFixed(2)}\nEmail: ${emailInput.value.trim()}`);
            discordButton.href = `https://discord.gg/lusiveofficial?payment=${paymentInfo}`;
        }

        function showPaymentFailure(message) {
            failurePage.classList.add('show');
            paymentError.textContent = message || 'Payment declined. Please try again.';
            paymentError.style.display = 'block';
        }

        function showError(inputId, errorId) {
            document.getElementById(inputId).classList.add('error');
            document.getElementById(errorId).classList.add('show');
        }

        function hideError(inputId, errorId) {
            document.getElementById(inputId).classList.remove('error');
            document.getElementById(errorId).classList.remove('show');
        }

        function luhnCheck(cardNumber) {
            let sum = 0;
            let isEven = false;

            for (let i = cardNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cardNumber.charAt(i));

                if (isEven) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9;
                    }
                }

                sum += digit;
                isEven = !isEven;
            }

            return sum % 10 === 0;
        }

        function validateExpiry(expiry) {
            if (expiry.length !== 5) return false;

            const [month, year] = expiry.split('/');
            const monthNum = parseInt(month);
            const yearNum = parseInt('20' + year);

            if (monthNum < 1 || monthNum > 12) return false;

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            if (yearNum < currentYear) return false;
            if (yearNum === currentYear && monthNum < currentMonth) return false;

            return true;
        }
    </script>
</body>
</html>
